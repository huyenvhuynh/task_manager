{% extends 'base.html' %}

<!-- Start Add Assignment -->
{% if user.is_authenticated and user.profile.role == 'user' %}
    <div
    class="modal fade"
    id="addAssignmentModal"
    tabindex="-1"
    aria-labelledby="addAssignmentModalLabel"
    aria-hidden="true"
    >
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
            <h5 class="modal-title" id="addAssignmentModalLabel">
            New Assignment
            </h5>
            <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
            ></button>
        </div>
        <!-- Modal Body with Form -->
        <div class="modal-body">
            <form
            action="{% url 'assignments:add_assignment' %}"
            method="post"
            enctype="multipart/form-data"
            >
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.path }}" />
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input
                type="text"
                class="form-control"
                id="title"
                name="title"
                required
                />
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea
                class="form-control"
                id="description"
                name="description"
                rows="3"
                required
                ></textarea>
            </div>
            <div class="mb-3">
                <label for="due_date" class="form-label">Due Date</label>
                <input
                type="date"
                class="form-control"
                id="due_date"
                name="due_date"
                required
                />
            </div>
            <div class="mb-3">
                <label for="course" class="form-label">Course</label>
                <select class="form-control" id="course" name="course" required>
                    {% for course in user.profile.courses.all %}
                        <option value="{{ course.id }}">{{ course.full_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="file_upload" class="form-label">Upload File</label>
                <input
                type="file"
                class="form-control"
                id="file_upload"
                name="file_upload"
                />
            </div>

            <!-- File Meta Data Section -->
            <div class="mb-3">
                <div class="d-flex align-items-center mb-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleMetaDataSection()">
                    <span id="keywordsToggleIcon">Add File Meta Data ▼</span>
                </button>
                </div>
                <!-- Metadata section container-->
                <div id="metadataContainer" style="display: none;">
                <!-- File Title -->
                <div class="mb-2">
                    <input
                    type="text"
                    class="form-control"
                    id="file_title"
                    name="file-title"
                    placeholder="File Title"
                    />
                </div>
                <!-- File Description -->
                <div class="mb-2">
                    <textarea
                    class="form-control"
                    id="file_description"
                    name="file-description"
                    rows="2"
                    placeholder="File Description"
                    ></textarea>
                </div>
                <!-- Keywords -->
                <div class="tags-input-container d-flex">
                    <input
                    type="text"
                    class="form-control me-2"
                    id="keywords-input"
                    placeholder="Add Keyword"
                    />
                    <!-- Add Keyword Button -->
                    <button type="button" class="btn btn-sm btn-primary" onclick="addTag()">
                    Add
                    </button>
                </div>
                <!-- Display of Keywords -->
                <div id="tagsDisplay" class="tags-display"><strong>Keywords: </strong></div>
                <!-- Hidden Input for Keywords -->
                <input type="hidden" name="keywords" id="keywords" />
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Add</button>
            </form>
        </div>
        </div>
    </div>
    </div>
{% endif %}

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript for Modal and Form Handling -->
<script>
    document.getElementById('addAssignmentModal').addEventListener('hidden.bs.modal', function () {
        window.location.reload();
    });

    function addTag() {
        const input = document.getElementById("keywords-input");
        const tagsDisplay = document.getElementById("tagsDisplay");
        const hiddenInput = document.getElementById("keywords");

        let tag = input.value.trim();
        if (tag) {
            const tagElement = document.createElement("span");
            tagElement.className = "tag";
            tagElement.textContent = tag;

            const deleteButton = document.createElement("span");
            deleteButton.className = "tag-delete";
            deleteButton.textContent = "×";
            deleteButton.onclick = function () {
                tagsDisplay.removeChild(tagElement);
                updateHiddenInput();
            };

            tagElement.appendChild(deleteButton);
            tagsDisplay.appendChild(tagElement);

            input.value = "";
            updateHiddenInput();
        }
    }

    function updateHiddenInput() {
        const tagsDisplay = document.getElementById("tagsDisplay");
        const hiddenInput = document.getElementById("keywords");

        let tags = Array.from(tagsDisplay.getElementsByClassName("tag")).map(
            (tag) => tag.textContent.replace("×", "").trim()
        );

        hiddenInput.value = tags.join(",");
    }

    function toggleMetaDataSection() {
        const metadataContainer = document.getElementById("metadataContainer");
        const keywordsToggleIcon = document.getElementById("keywordsToggleIcon");

        if (metadataContainer.style.display === "none") {
            metadataContainer.style.display = "block";
            keywordsToggleIcon.textContent = "Add File Meta Data ▲";
        } else {
            metadataContainer.style.display = "none";
            keywordsToggleIcon.textContent = "Add File Meta Data ▼";
        }
    }
</script>